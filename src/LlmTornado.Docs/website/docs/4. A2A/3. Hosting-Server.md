# A2A Hosting Server

## Overview

The A2A Hosting Server is an experimental orchestration platform that manages multiple dockerized A2A Agent Servers. It handles agent lifecycle, routing, and communication between distributed agents.

## Prerequisites

- Docker Desktop installed and running
- .NET 8.0 SDK or later
- LlmTornado.A2A.Hosting package

## Quick Start

```csharp
using LlmTornado.A2A.Hosting;

WebApplicationBuilder builder = WebApplication.CreateBuilder(args);

// Add hosting server services
builder.Services.AddA2AHostingServer(options =>
{
    options.DockerHost = "unix:///var/run/docker.sock"; // Linux/Mac
    // options.DockerHost = "npipe://./pipe/docker_engine"; // Windows
    options.AgentRegistryPath = "./agents";
});

WebApplication app = builder.Build();

// Map hosting endpoints
app.MapA2AHostingEndpoints();

app.Run();
```

## Architecture

The hosting server provides:
- **Agent Discovery**: Automatically discover available agent servers
- **Lifecycle Management**: Start, stop, restart agent containers
- **Request Routing**: Route requests to appropriate agent servers
- **Health Monitoring**: Track agent server health and availability
- **Load Balancing**: Distribute requests across agent instances

## Managing Agent Servers

### Launch Agent Server

```csharp
// Via API
POST /hosting/agents/launch
{
  "agentName": "weather-agent",
  "imageTag": "weather-agent:latest",
  "port": 5001,
  "environmentVariables": {
    "OPENAI_API_KEY": "your-key"
  }
}

// Via SDK
HostingClient hosting = new HostingClient("http://localhost:8000");
AgentInstance agent = await hosting.LaunchAgent(new AgentLaunchRequest
{
    AgentName = "weather-agent",
    ImageTag = "weather-agent:latest",
    Port = 5001,
    EnvironmentVariables = new Dictionary<string, string>
    {
        ["OPENAI_API_KEY"] = "your-key"
    }
});
```

### Stop Agent Server

```csharp
// Via API
POST /hosting/agents/{agentId}/stop

// Via SDK
await hosting.StopAgent(agentId);
```

### List Running Agents

```csharp
// Via API
GET /hosting/agents

// Via SDK
List<AgentInstance> agents = await hosting.ListAgents();
foreach (AgentInstance agent in agents)
{
    Console.WriteLine($"{agent.Name}: {agent.Status}");
}
```

### Get Agent Status

```csharp
// Via API
GET /hosting/agents/{agentId}/status

// Via SDK
AgentStatus status = await hosting.GetAgentStatus(agentId);
Console.WriteLine($"Status: {status.State}");
Console.WriteLine($"Uptime: {status.Uptime}");
Console.WriteLine($"Requests: {status.RequestCount}");
```

## API Commands Without Web UI

### Using cURL

```bash
# Launch agent
curl -X POST http://localhost:8000/hosting/agents/launch \
  -H "Content-Type: application/json" \
  -d '{
    "agentName": "weather-agent",
    "imageTag": "weather-agent:latest",
    "port": 5001,
    "environmentVariables": {
      "OPENAI_API_KEY": "your-key"
    }
  }'

# List agents
curl http://localhost:8000/hosting/agents

# Get agent status
curl http://localhost:8000/hosting/agents/{agentId}/status

# Stop agent
curl -X POST http://localhost:8000/hosting/agents/{agentId}/stop

# Restart agent
curl -X POST http://localhost:8000/hosting/agents/{agentId}/restart

# Route request to agent
curl -X POST http://localhost:8000/hosting/agents/{agentId}/message \
  -H "Content-Type: application/json" \
  -d '{"message": "What is the weather?"}'
```

### Using HTTP Client

```csharp
public class HostingClient
{
    readonly HttpClient client;
    
    public HostingClient(string baseUrl)
    {
        client = new HttpClient { BaseAddress = new Uri(baseUrl) };
    }
    
    public async Task<AgentInstance> LaunchAgent(AgentLaunchRequest request)
    {
        StringContent content = new StringContent(
            JsonConvert.SerializeObject(request),
            Encoding.UTF8,
            "application/json"
        );
        
        HttpResponseMessage response = await client.PostAsync(
            "/hosting/agents/launch",
            content
        );
        
        response.EnsureSuccessStatusCode();
        string json = await response.Content.ReadAsStringAsync();
        return JsonConvert.DeserializeObject<AgentInstance>(json);
    }
    
    public async Task<List<AgentInstance>> ListAgents()
    {
        HttpResponseMessage response = await client.GetAsync("/hosting/agents");
        response.EnsureSuccessStatusCode();
        string json = await response.Content.ReadAsStringAsync();
        return JsonConvert.DeserializeObject<List<AgentInstance>>(json);
    }
    
    public async Task StopAgent(string agentId)
    {
        HttpResponseMessage response = await client.PostAsync(
            $"/hosting/agents/{agentId}/stop",
            null
        );
        response.EnsureSuccessStatusCode();
    }
}
```

## Configuration

```csharp
builder.Services.AddA2AHostingServer(options =>
{
    // Docker configuration
    options.DockerHost = "unix:///var/run/docker.sock";
    
    // Agent registry
    options.AgentRegistryPath = "./agents";
    
    // Network configuration
    options.NetworkName = "a2a-network";
    options.SubnetPrefix = "172.20.0";
    
    // Resource limits
    options.DefaultMemoryLimit = "512m";
    options.DefaultCpuLimit = "1.0";
    
    // Health check settings
    options.HealthCheckInterval = TimeSpan.FromSeconds(30);
    options.HealthCheckTimeout = TimeSpan.FromSeconds(5);
    
    // Logging
    options.LogContainerOutput = true;
});
```

## Docker Network Configuration

The hosting server creates a dedicated Docker network for agent communication:

```csharp
// Automatically created network
{
  "Name": "a2a-network",
  "Driver": "bridge",
  "Subnet": "172.20.0.0/16",
  "Gateway": "172.20.0.1"
}

// Agents get assigned IPs
// weather-agent: 172.20.0.2
// task-agent: 172.20.0.3
```

## Monitoring and Logs

### View Agent Logs

```bash
# Via API
curl http://localhost:8000/hosting/agents/{agentId}/logs

# Via Docker CLI
docker logs {containerId}
```

### Health Monitoring

```csharp
// Configure health checks
options.HealthCheckInterval = TimeSpan.FromSeconds(30);

// Custom health check endpoint
app.MapHealthChecks("/health");

// Monitor agent health
AgentHealth health = await hosting.CheckAgentHealth(agentId);
if (health.Status == HealthStatus.Unhealthy)
{
    await hosting.RestartAgent(agentId);
}
```

## Best Practices

### Resource Management
- Set appropriate memory and CPU limits
- Monitor resource usage
- Implement auto-scaling for high load
- Clean up stopped containers regularly

### Networking
- Use dedicated Docker network
- Implement service discovery
- Configure DNS resolution
- Use load balancing for multiple instances

### Security
- Use private Docker registries
- Implement authentication
- Encrypt agent communication
- Manage secrets securely
- Scan images for vulnerabilities

### Reliability
- Implement health checks
- Auto-restart failed agents
- Monitor and alert on failures
- Maintain agent logs
- Backup agent configurations

## Troubleshooting

### Docker Not Running
```bash
# Check Docker status
docker ps

# Start Docker Desktop
# On Linux: sudo systemctl start docker
```

### Agent Won't Start
```bash
# Check logs
curl http://localhost:8000/hosting/agents/{agentId}/logs

# Verify Docker image
docker images | grep agent-name

# Check port conflicts
docker ps -a
```

### Network Issues
```bash
# Inspect network
docker network inspect a2a-network

# Restart network
docker network rm a2a-network
# Restart hosting server (recreates network)
```

## Related Topics

- [A2A Getting Started](./1.%20Getting-Started.md)
- [Agent Server](./2.%20Agent-Server.md)
- [Web UI](./4.%20Web-UI.md)
