# A2A Agent Server

## Overview

The A2A Agent Server is the core component that hosts individual agents as HTTP services. It provides REST API endpoints for agent interaction, manages agent lifecycle, and handles request routing.

## Quick Start

```csharp
using LlmTornado.A2A;
using LlmTornado.Agents;

// 1. Create your agent runtime
public class MyAgentRuntime : BaseA2ATornadoRuntimeConfiguration
{
    public override AgentCard DescribeAgentCard(string agentUrl)
    {
        return new AgentCard
        {
            Name = "MyAgent",
            Description = "Specialized agent for specific tasks",
            Url = agentUrl
        };
    }
}

// 2. Configure and run agent server (Program.cs)
WebApplicationBuilder builder = WebApplication.CreateBuilder(args);

// Add A2A Agent Server services
builder.Services.AddA2AAgentServer<MyAgentRuntime>();

WebApplication app = builder.Build();

// Map A2A endpoints
app.MapA2AAgentEndpoints();

app.Run();
```

## Building an Agent Server

### Step 1: Create Your Agent

Define your agent's behavior and capabilities:

```csharp
public class WeatherAgentRuntime : BaseA2ATornadoRuntimeConfiguration
{
    string GetWeather(string city)
    {
        return $"Weather in {city}: Sunny, 22Â°C";
    }
    
    string GetForecast(string city, int days)
    {
        return $"{days}-day forecast for {city}: ...";
    }
    
    protected override TornadoAgent CreateAgent()
    {
        return new TornadoAgent(
            client: api,
            model: ChatModel.OpenAi.Gpt41.V41Mini,
            instructions: "You provide weather information and forecasts.",
            tools: new List<Delegate> { GetWeather, GetForecast }
        );
    }
    
    public override AgentCard DescribeAgentCard(string agentUrl)
    {
        return new AgentCard
        {
            Name = "WeatherAgent",
            Description = "Provides weather and forecast information",
            Url = agentUrl,
            Version = "1.0.0",
            Capabilities = new[] { "weather", "forecast" }
        };
    }
}
```

### Step 2: Add Agent to Program.cs

```csharp
using LlmTornado.A2A;

WebApplicationBuilder builder = WebApplication.CreateBuilder(args);

// Configure API keys from environment or configuration
string apiKey = builder.Configuration["OPENAI_API_KEY"] 
    ?? Environment.GetEnvironmentVariable("OPENAI_API_KEY");

// Add A2A services
builder.Services.AddA2AAgentServer<WeatherAgentRuntime>(options =>
{
    options.ApiKey = apiKey;
    options.EnableSwagger = true;
    options.EnableHealthChecks = true;
});

WebApplication app = builder.Build();

// Enable Swagger in development
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

// Map A2A endpoints
app.MapA2AAgentEndpoints();

app.Run();
```

### Step 3: Build the Project

```bash
dotnet build
```

## Docker Deployment

### Step 4: Configure Environment Variables

Add API key to `launchSettings.json`:

```json
{
  "profiles": {
    "Docker": {
      "commandName": "Docker",
      "launchBrowser": true,
      "environmentVariables": {
        "OPENAI_API_KEY": "your-api-key-here"
      },
      "publishAllPorts": true,
      "useSSL": false
    }
  }
}
```

### Step 5: Build Docker Image

```bash
docker build -t weather-agent .
```

### Step 6: Run Docker Container

```bash
# Run with API key from environment
docker run -it -p 5000:80 \
  -e OPENAI_API_KEY=your_api_key \
  weather-agent

# Or run with multiple environment variables
docker run -it -p 5000:80 \
  -e OPENAI_API_KEY=your_api_key \
  -e ANTHROPIC_API_KEY=your_anthropic_key \
  weather-agent
```

## API Endpoints

The agent server exposes the following endpoints:

### Get Agent Card
```http
GET /agent/card
```
Returns the agent's capabilities and metadata.

### Send Message to Agent
```http
POST /agent/message
Content-Type: application/json

{
  "message": "What's the weather in Prague?",
  "context": {}
}
```

### Health Check
```http
GET /health
```
Returns agent server health status.

## Configuration Options

```csharp
builder.Services.AddA2AAgentServer<MyAgentRuntime>(options =>
{
    // API keys
    options.ApiKey = "your-api-key";
    
    // Swagger documentation
    options.EnableSwagger = true;
    
    // Health checks
    options.EnableHealthChecks = true;
    
    // Logging
    options.LogLevel = LogLevel.Information;
    
    // Timeout settings
    options.RequestTimeout = TimeSpan.FromSeconds(30);
    
    // Rate limiting
    options.EnableRateLimiting = true;
    options.MaxRequestsPerMinute = 60;
});
```

## Testing Your Agent Server

### Using cURL

```bash
# Get agent card
curl http://localhost:5000/agent/card

# Send message
curl -X POST http://localhost:5000/agent/message \
  -H "Content-Type: application/json" \
  -d '{"message": "What is the weather in London?"}'
```

### Using HTTPClient

```csharp
HttpClient client = new HttpClient();

// Get agent card
HttpResponseMessage cardResponse = await client.GetAsync("http://localhost:5000/agent/card");
string card = await cardResponse.Content.ReadAsStringAsync();

// Send message
StringContent content = new StringContent(
    JsonConvert.SerializeObject(new { message = "What's the weather?" }),
    Encoding.UTF8,
    "application/json"
);

HttpResponseMessage response = await client.PostAsync(
    "http://localhost:5000/agent/message",
    content
);

string result = await response.Content.ReadAsStringAsync();
```

## Best Practices

### Error Handling
- Implement global exception handling
- Return appropriate HTTP status codes
- Log errors for debugging
- Provide meaningful error messages

### Performance
- Use async/await throughout
- Implement caching where appropriate
- Monitor resource usage
- Set appropriate timeouts

### Security
- Validate all inputs
- Use HTTPS in production
- Implement authentication
- Rate limit requests
- Sanitize outputs

### Monitoring
- Implement health checks
- Log all requests
- Track performance metrics
- Monitor error rates
- Set up alerts

## Related Topics

- [A2A Getting Started](./1.%20Getting-Started.md)
- [Hosting Server](./3.%20Hosting-Server.md)
- [Web UI](./4.%20Web-UI.md)
- [Agent Basics](../2.%20Agents/1.%20Getting-Started.md)
