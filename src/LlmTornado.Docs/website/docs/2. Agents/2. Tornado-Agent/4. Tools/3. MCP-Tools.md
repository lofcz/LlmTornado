# MCP Tools

## Overview

MCP (Model Context Protocol) tools allow agents to use standardized external tools provided by MCP servers. This enables seamless integration with a wide ecosystem of tools and services.

## Quick Start

```csharp
using LlmTornado.Agents;
using ModelContextProtocol.Client;

// Create MCP client
IMcpClient mcpClient = await McpClientFactory.CreateAsync(transport);

// Create MCP server wrapper
MCPServer mcpServer = new MCPServer(mcpClient);

// Create agent with MCP tools
TornadoAgent agent = new TornadoAgent(
    client: api,
    model: ChatModel.OpenAi.Gpt41.V41,
    instructions: "You have access to weather data via MCP.",
    mcpServers: new List<MCPServer> { mcpServer }
);

// Agent automatically discovers and uses MCP tools
Conversation result = await agent.RunAsync("What's the weather in Seattle?");
```

## Setting Up MCP Servers

### Single MCP Server

```csharp
// Create transport (e.g., Stdio)
StdioClientTransport transport = new StdioClientTransport(new StdioClientTransportOptions
{
    Command = "path/to/mcp-server",
    Arguments = new[] { "--config", "config.json" }
});

// Create client
IMcpClient mcpClient = await McpClientFactory.CreateAsync(transport);

// Add to agent
MCPServer mcpServer = new MCPServer(mcpClient);
TornadoAgent agent = new TornadoAgent(
    api, model,
    mcpServers: new List<MCPServer> { mcpServer }
);
```

### Multiple MCP Servers

```csharp
// Create multiple MCP clients
IMcpClient weatherClient = await McpClientFactory.CreateAsync(weatherTransport);
IMcpClient databaseClient = await McpClientFactory.CreateAsync(dbTransport);

// Wrap in MCPServer objects
List<MCPServer> mcpServers = new List<MCPServer>
{
    new MCPServer(weatherClient),
    new MCPServer(databaseClient)
};

// Agent has access to all tools
TornadoAgent agent = new TornadoAgent(
    api, model,
    mcpServers: mcpServers
);
```

## Tool Discovery

MCP tools are automatically discovered when the agent is created:

```csharp
TornadoAgent agent = new TornadoAgent(api, model, mcpServers: servers);

// Tools are automatically fetched and registered
// Agent knows what tools are available and how to use them
Conversation result = await agent.RunAsync("Use the available tools to help me");
```

## Tool Execution

MCP tools are executed remotely on the MCP server:

```csharp
// Agent automatically:
// 1. Determines which tool to call
// 2. Infers required arguments
// 3. Calls tool on remote MCP server
// 4. Processes the result
// 5. Uses result to formulate response

TornadoAgent agent = new TornadoAgent(api, model, mcpServers: servers);
Conversation result = await agent.RunAsync("Get the forecast for Dallas");
// Agent calls the forecast tool remotely and returns the result
```

## Best Practices

### Server Management
- Properly initialize MCP servers before creating agents
- Dispose of MCP clients when done
- Handle connection failures gracefully
- Monitor server health

### Error Handling

```csharp
try
{
    IMcpClient mcpClient = await McpClientFactory.CreateAsync(transport);
    MCPServer mcpServer = new MCPServer(mcpClient);
    
    TornadoAgent agent = new TornadoAgent(
        api, model,
        mcpServers: new List<MCPServer> { mcpServer }
    );
    
    Conversation result = await agent.RunAsync(prompt);
}
catch (Exception ex)
{
    Console.WriteLine($"MCP error: {ex.Message}");
    // Fallback to agent without MCP tools
}
```

### Performance
- Reuse MCP clients across agent instances
- Cache tool lists when possible
- Implement timeouts for remote calls
- Monitor tool execution times

## Common Issues

### MCP Server Not Responding
**Solutions**:
- Verify server is running
- Check transport configuration
- Ensure network connectivity
- Review server logs

### Tools Not Available
**Solutions**:
- Confirm MCP server has tools registered
- Check agent initialization succeeded
- Verify server is compatible with protocol version

### Tool Execution Fails
**Solutions**:
- Validate tool parameters
- Check server error logs
- Ensure required dependencies are available
- Test tools independently

## Related Topics

- [Function Tools](./1.%20Function-Tools.md)
- [MCP Documentation](../../../3.%20MPC/MPC.md)
- [Agent Basics](../1.%20basics.md)
